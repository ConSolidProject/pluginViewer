(self.webpackChunkviewer=self.webpackChunkviewer||[]).push([[38,487],{1487:(t,e,a)=>{"use strict";a.r(e),a.d(e,{checkExistence:()=>f,checkInvites:()=>k,createLBDLocation:()=>C,createProject:()=>P,createResource:()=>H,deleteResource:()=>u,executeQuery:()=>p,findObjectAliases:()=>I,getAccessRights:()=>A,getAuthorisedFilesInRepository:()=>R,getLBDlocation:()=>T,getLocalContexts:()=>$,getMyArtefactRegistry:()=>L,getMyProjectRepository:()=>W,getProjectDataFromStakeholder:()=>E,getProjectId:()=>v,getProjectsFromAggregator:()=>m,getStakeholdersFromProject:()=>x,loadProjectMetadata:()=>g,update:()=>j,uploadResource:()=>S});var n=a(55877);const r=a(4501),{DataFactory:o}=r,{namedNode:i,literal:s,defaultGraph:c,quad:w}=o,l=a(7265).newEngine,{v4:d}=a(55877);async function p(t,e,a){const n=new r.Store;for(const t of e)try{const e=await a.fetch(t),o=await e.text(),i=new r.Parser;await b(o,n,i,t)}catch(t){console.log(t)}const o="\nprefix ldp: <http://www.w3.org/ns/ldp#> \nprefix lbd: <https://lbdserver.org/vocabulary#>\nprefix dcat: <http://www.w3.org/ns/dcat#>\nprefix owl: <http://www.w3.org/2002/07/owl#> \n "+t,i=l();return await i.query(o,{sources:[n]})}async function f(t,e){try{const a={method:"HEAD"};return 200===(await e.fetch(t,a)).status}catch(e){throw e.message=`Could not check existence of graph ${t} - ${e.message}`,e}}async function u(t,e){try{var a={method:"DELETE"};await e.fetch(t.main,a),await e.fetch(t.metadata,a);var n={method:"PATCH",headers:{"Content-Type":"application/sparql-update"},body:`\nprefix ldp: <http://www.w3.org/ns/ldp#> \nprefix lbd: <https://lbdserver.org/vocabulary#>\nprefix dcat: <http://www.w3.org/ns/dcat#>\nprefix owl: <http://www.w3.org/2002/07/owl#> \n DELETE WHERE {\n    ?art lbd:hasLinkElement ?le .\n    ?le lbd:hasDocument <${t.main}> ; lbd:hasIdentifier ?identifier .\n    ?identifier lbd:identifier ?id .\n  }`,redirect:"follow"};return console.log("resource.artefactRegistry",t.artefactRegistry),void await e.fetch(t.artefactRegistry,n)}catch(t){console.log("error",t)}}async function h(t,e){const a={};for(const n of e)try{const e=await t.bindings();a[n]=e.map((t=>t.get("?"+n).id)).filter((t=>null!=t))}catch(t){console.log("error",t)}return a}async function g(t,e,a){try{const n=await v(t),o=await x(t,a);for(const t of o){const o=await T(t,a)+n+"/artefactRegistry.ttl",i=await a.fetch(o);if(i){const t=await i.text();if(t){const a=new r.Parser;await b(t,e,a,o)}}else console.log(t,"has no artefact registry")}}catch(t){console.log("error",t)}}function y(t,e){if(t.id.startsWith("http"))return i(t.id);if(t.id.startsWith('"')){const e=t.id.replaceAll('"',"");return s(e)}return i(e+t.id)}function b(t,e,a,n){return new Promise(((r,o)=>{t&&a.parse(t,((t,a,o)=>{if(t&&console.log(t),a){const t=y(a.subject,n),r=y(a.predicate,n),o=y(a.object,n),i=w(t,r,o,c());e.addQuad(i)}else r()}))}))}async function m(t,e){let a=t;a.endsWith("/")||(a+="/");const n=await p("\n  SELECT ?project WHERE {\n    ?s a lbd:Aggregator ;\n      ldp:contains ?project .\n  }",[a],e),{project:r}=await h(n,["project"]);return r}async function v(t,e){return t.split("/")[t.split("/").length-2]}async function x(t,e){let a=t;a.endsWith("/")||(a+="/");const n=`\n  SELECT ?st WHERE {\n    <${t}> a lbd:PartialProject ;\n      lbd:hasMember ?st .\n  }`,r=await p(n,[t],e),{st:o}=await h(r,["st"]);return o}async function E(t,e,a){const n=await T(t,a);e.endsWith("/")||(e+="/");const r=n+e;return{stakeholder:t,data:await R(r,a)}}async function R(t,e){const a=`\n    SELECT ?dataset WHERE {\n      <${t}> ldp:contains ?dataset .\n    }\n  `,n=await p(a,[t],e),{dataset:r}=await h(n,["dataset"]),o=r.filter((t=>t.endsWith("props.ttl"))),i=[];for(const a of o){const n=await A(a,e),r="\n    SELECT ?uri WHERE {\n      ?meta a dcat:Dataset ;\n      dcat:distribution ?dist .\n      ?dist dcat:downloadURL ?uri .\n    }",o=await p(r,[a],e),{uri:s}=await h(o,["uri"]);i.push({artefactRegistry:t+"artefactRegistry.ttl",accessRights:n,metadata:a,main:s[0]})}return i}async function A(t,e){return(await e.fetch(t,{method:"HEAD"})).headers.get("WAC-Allow").split(",")[0].replace("user=","").replaceAll('"',"").split(" ")}async function T(t,e){const a=`\nprefix ldp: <http://www.w3.org/ns/ldp#> \nprefix lbd: <https://lbdserver.org/vocabulary#>\nprefix dcat: <http://www.w3.org/ns/dcat#>\nprefix owl: <http://www.w3.org/2002/07/owl#> \n select ?index where {<${t}> lbd:hasProjectRegistry ?index}`,n=await p(a,[t.replace("#me","")],e);let{index:r}=await h(n,["index"]);return r.length>0?(r[0].endsWith("/")||(r+="/"),r[0]):null}async function j(t,e,a){try{var n={method:"PATCH",headers:{"Content-Type":"application/sparql-update"},body:t,redirect:"follow"};let r;return void(r=await a.fetch(e,n))}catch(t){throw console.log("error",t),t}}async function I(t,e,a){const n=`\n  SELECT ?alias WHERE {\n  <${t}> owl:sameAs ?alias .\n  }\n  `,r=await p(n,e,a),{alias:o}=await h(r,["alias"]);return o}async function $(t,e,a){}async function C(t){if(t.info.isLoggedIn){let e=await T(t.info.webId,t);e||(e=t.info.webId.replace("/profile/card#me","/lbd/"));const a=`\nprefix ldp: <http://www.w3.org/ns/ldp#> \nprefix lbd: <https://lbdserver.org/vocabulary#>\nprefix dcat: <http://www.w3.org/ns/dcat#>\nprefix owl: <http://www.w3.org/2002/07/owl#> \n INSERT DATA {\n      <${t.info.webId}> lbd:hasProjectRegistry <${e}> .\n    }`;await j(a,t.info.webId,t);const n=`\nprefix ldp: <http://www.w3.org/ns/ldp#> \nprefix lbd: <https://lbdserver.org/vocabulary#>\nprefix dcat: <http://www.w3.org/ns/dcat#>\nprefix owl: <http://www.w3.org/2002/07/owl#> \n INSERT DATA {\n      <${e}> a lbd:Aggregator .\n    }`;return await j(n,e,t),e}}async function P(t,e,a){if(a.info.isLoggedIn){t||(t=d()),e||(e=[a.info.webId]);let r=await T(a.info.webId,a);r||(r=await C(a));const o=r+t+"/",i=`\nprefix ldp: <http://www.w3.org/ns/ldp#> \nprefix lbd: <https://lbdserver.org/vocabulary#>\nprefix dcat: <http://www.w3.org/ns/dcat#>\nprefix owl: <http://www.w3.org/2002/07/owl#> \n INSERT DATA {\n      <${o}> a lbd:PartialProject ;\n      lbd:hasProjectUri <${o}>;\n      lbd:hasProjectId "${t}";\n      lbd:hasLocalArtefactRegistry <${o}artefactRegistry.ttl> .\n    }`;await j(i,o,a);for(const t of e){const e=`\nprefix ldp: <http://www.w3.org/ns/ldp#> \nprefix lbd: <https://lbdserver.org/vocabulary#>\nprefix dcat: <http://www.w3.org/ns/dcat#>\nprefix owl: <http://www.w3.org/2002/07/owl#> \n INSERT DATA {\n        <${o}> lbd:hasMember <${t}> .\n      }`;await j(e,o,a),await q(t,o,a)}await H(`${o}artefactRegistry.ttl`,{mimeType:"text/turtle"},a),await S(o+".acl",(t=>`\n    @prefix  acl:  <http://www.w3.org/ns/auth/acl#> .       \n      \n    <#${(0,n.v4)()}>\n        a acl:Authorization;\n        acl:accessTo    <./>;\n        acl:default     <./> ;\n        <http://www.w3.org/ns/auth/acl#agent> <${t.info.webId}>;\n        acl:mode <http://www.w3.org/ns/auth/acl#Read>, <http://www.w3.org/ns/auth/acl#Write>, <http://www.w3.org/ns/auth/acl#Append>, <http://www.w3.org/ns/auth/acl#Control>.\n            \n    <#${(0,n.v4)()}>\n        a acl:Authorization;\n        acl:accessTo    <./>;\n        acl:default     <./> ;\n        <http://www.w3.org/ns/auth/acl#agentClass> <http://xmlns.com/foaf/0.1/Agent>;\n        acl:mode <http://www.w3.org/ns/auth/acl#Read>.\n    `)(a),{mimeType:"text/turtle"},a)}}async function L(t,e){return await T(t.info.webId,t)+await v(e)+"/artefactRegistry.ttl"}async function S(t,e,a,n){try{if(!a.overwrite&&await f(t,n))throw new Error("Resource already exists");let o;a.mimeType?o=a.mimeType:(o=mime.lookup(t),!1===o&&(o="text/plain"));var r={method:"PUT",headers:{"Content-Type":o},body:e,redirect:"follow"};let i;return i=await n.fetch(t,r),void(205!==i.status&&(i=await fetch(t,r)))}catch(t){throw console.log("error",t),t.message=`Unable to upload resource - ${t.message}`,t}}async function W(t,e){const a=await T(e.info.webId,e),n=a+await v(t)+"/";if((await m(a,e)).includes(n))return console.log("guess",n),n;throw Error("Can't find your project. Could it be you need to initiate it first?")}async function D(t,e){const a=await p(`prefix ldp: <http://www.w3.org/ns/ldp#> select * where {<${t}> ldp:inbox ?inbox .}`,[t],e),n=await a.bindings();console.log("bind",n);let r=n[0].get("?inbox").id;return r.endsWith("/")||(r+="/"),r}async function k(t){const e=await D(t.info.webId,t),a=await R(e,t),n=await T(t.info.webId,t),r=await m(n,t),o=await query(a,"\n  prefix lbd: <https://lbdserver.org/vocabulary#> \n  prefix as: <https://www.w3.org/ns/activitystreams#> \n  SELECT ?sender WHERE {?invite a lbd:projectInvitation. ?this as:actor ?sender; as:object ?invite .}");await p(query,a,t);const{sender:i}=await h(projects,["sender"]);return o.map((t=>t.sender.value)).filter((t=>!r.includes(t)))}async function H(t,e,a){await S(t,"",e,a)}async function q(t,e,a){const n=a.info.webId,r=await D(t,a)+d()+".ttl",o=`\n  @prefix foaf: <http://xmlns.com/foaf/0.1/>.\n  @prefix solid: <http://www.w3.org/ns/solid/terms#>.\n  @prefix lbd: <https://lbdserver.org/vocabulary#>.\n  @prefix ldp: <http://www.w3.org/ns/ldp#> .\n  @prefix as: <https://www.w3.org/ns/activitystreams#> .\n  @prefix xsd: <http://www.w3.org/2001/XMLSchema#> .\n  @prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.\n\n<>\n  a as:Announce ;\n  as:actor <${n}> ;\n  as:object <#invite> ;\n  as:target <${t}> ;\n  as:updated "${(new Date).toISOString()}"^^xsd:dateTime .\n\n<#invite> a lbd:projectInvitation, rdfs:seeAlso <${e}>  .\n  `;await S(r,o,{mimeType:"text/turtle"},a)}},55877:(t,e,a)=>{var n=a(23570),r=a(71171),o=r;o.v1=n,o.v4=r,t.exports=o},45327:t=>{for(var e=[],a=0;a<256;++a)e[a]=(a+256).toString(16).substr(1);t.exports=function(t,a){var n=a||0,r=e;return[r[t[n++]],r[t[n++]],r[t[n++]],r[t[n++]],"-",r[t[n++]],r[t[n++]],"-",r[t[n++]],r[t[n++]],"-",r[t[n++]],r[t[n++]],"-",r[t[n++]],r[t[n++]],r[t[n++]],r[t[n++]],r[t[n++]],r[t[n++]]].join("")}},85217:t=>{var e="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(e){var a=new Uint8Array(16);t.exports=function(){return e(a),a}}else{var n=new Array(16);t.exports=function(){for(var t,e=0;e<16;e++)0==(3&e)&&(t=4294967296*Math.random()),n[e]=t>>>((3&e)<<3)&255;return n}}},23570:(t,e,a)=>{var n,r,o=a(85217),i=a(45327),s=0,c=0;t.exports=function(t,e,a){var w=e&&a||0,l=e||[],d=(t=t||{}).node||n,p=void 0!==t.clockseq?t.clockseq:r;if(null==d||null==p){var f=o();null==d&&(d=n=[1|f[0],f[1],f[2],f[3],f[4],f[5]]),null==p&&(p=r=16383&(f[6]<<8|f[7]))}var u=void 0!==t.msecs?t.msecs:(new Date).getTime(),h=void 0!==t.nsecs?t.nsecs:c+1,g=u-s+(h-c)/1e4;if(g<0&&void 0===t.clockseq&&(p=p+1&16383),(g<0||u>s)&&void 0===t.nsecs&&(h=0),h>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");s=u,c=h,r=p;var y=(1e4*(268435455&(u+=122192928e5))+h)%4294967296;l[w++]=y>>>24&255,l[w++]=y>>>16&255,l[w++]=y>>>8&255,l[w++]=255&y;var b=u/4294967296*1e4&268435455;l[w++]=b>>>8&255,l[w++]=255&b,l[w++]=b>>>24&15|16,l[w++]=b>>>16&255,l[w++]=p>>>8|128,l[w++]=255&p;for(var m=0;m<6;++m)l[w+m]=d[m];return e||i(l)}},71171:(t,e,a)=>{var n=a(85217),r=a(45327);t.exports=function(t,e,a){var o=e&&a||0;"string"==typeof t&&(e="binary"===t?new Array(16):null,t=null);var i=(t=t||{}).random||(t.rng||n)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,e)for(var s=0;s<16;++s)e[o+s]=i[s];return e||r(i)}}}]);